# Оценочная функция (evaluation)

С чем вы познакомитесь на этом блоке:

* попробуете основные инструменты разработки и тестирования своих ботов — утилитами builder, brutaltester, CG Spunk.
* концепцией оценочной функции. 
* концепцией диаграммы Вороного и ее применением в игровых ИИ.
* некоторыми методами отладки игровых ботов.

## Предварительная подготовка

Познакомьтесь с игрой 
[WonDevWoman](https://www.codingame.com/multiplayer/bot-programming/wondev-woman).
Склонируйте этот репозиторий и почитайте уже написанный код. 
Особенно код симуляции игры в классе State.cs

Познакомьтесь с концепцией диаграммы Вороного, 
[в этом уроке](https://tech.io/playgrounds/243/voronoi-diagrams/what-are-voronoi-diagrams). 

Прочитайте теорию ниже.

### Теория

Самый простой подход к созданию игровых ИИ — выбирать каждый раз самый лучший ход 
с точки зрения некоторой оценочной функции. Этот подход реализован в классе `GreedyAi`.

Оценочная функция берет состояние игры на вход, а на выход даёт число — чем больше, 
тем лучше состояние игры для текущего игрока.

В играх в двумя соперниками обычно удобно функцию оценки оформлять так:

```
return EvaluateForPlayer(me, state) - EvaluateForPlayer(enemy, state);
```

Где `EvaluateForPlayer` — это вспомогательная функция, принимающая во внимание состояние только того игрока,
которого передали вторым аргументом.

Например, в этой игре `EvaluateForPlayer` может включать в себя количество возможных ходов 
и суммарную высоту юнитов в линейной комбинации.

Коэффициенты линейной комбинации можно выбрать из общих соображений, но лучше подобрать 
в серии экспериментов.



## Задача

Ваше основное задание — реализовав только оценочную функцию для GreedyAi, 
побеждать в 70% случаев заготовленного авторами курса бота `ww-bosses/greedy.exe`. 

Дополнительное задание — попасть в золотую лигу на codingame.com.

Вот что для этого придется сделать:

1. Придумайте оценочную функцию и реализуйте ее в классе `StateEvaluator`. 
Для начала реализуйте что-то очень простое и наивное и научитесь запускать и тестировать вашего бота. 

2. Чтобы сравнить своего бота с боссом, запустите `bt-ww-greedy.cmd`. 
На консоли будет виден прогресс, кто кого побеждает в каждой из игр.
Пока идут бои, изучите устройство этого батника. Он вызывает готовую утилиту [brutaltester](https://github.com/dreignier/cg-brutaltester)
 — универсальную утилиту тестирования, подходящую для многих игр codingame.
Почитайте документцию на brutaltester, она может пригодится для кастомизации его запуска под свои нужды. 

3. Посмотреть визуально, как играет ваш бот можно на сайте codingame.com. 
Для этого запустите  `wondevwoman/build.cmd` — он соберет весь код вашего бота 
в один исходник и скопирует его в буфер обмена. После этого его можно вставить в IDE на codingame.com.

4. Как только освоитесь с инструментами сборки и тестирования, 
приступайте к придумыванию и реализации более умной оценочной функции. 
В частности можно вспомнить про диаграмму Вороного.

5. Когда вы перейдете к тонкой настройке вашего бота, может пригодится ещё один инструмент тестирования 
качества его игры — с помощью расширения для Chrome [CG Spunk](https://chrome.google.com/webstore/detail/cg-spunk/bkmddelokmckldmgeeiheohknodgaphi).
Оно поможет запустить серию боёв бота с заданными соперниками прямо в вашем браузере в IDE CodinGame, 
увидеть статистику, посмотреть наличие таймаутов или необработанных исключений и даже просмотреть логи.

## Отладка

Большую часть времени при разработке бота вы будете проводить за отладкой. 
Тут собраны несколько трюков, которые облегчат вам жизнь. 

1. Для отладки удобно кроме собственно числового значения оценки сохранять ещё что-то, 
что поможет вам понять, почему оценка именно такая. Для этого есть класс `ExplainedScore` 
— можете пользоваться его возможностями.

2. Есть ещё одна возможность отладочного вывода.
При выводе команд всё, что будет написано после команды в той же строке,
выводится codingame как сообщение вашего бота в окне визаулизации. Это тоже может быть полезно.
Обратите внимание на свойство `Message` у `IGameAction`, которое пока не используется.

3. Во всех играх codingame можно выводить отладочную информацию в поток вывода Error, это делается так:    
    ```
    Console.Error.WriteLine(bestMove.Score.Explanation);
    ```  
    Результат будет виден в логе игры под окном визуализации.
    Обратите внимание, как это используется для вывода всех входных данных классом BaseStateReader.
    С этой техникой вы можете действовать так: 
    если вы увидели в визуализаторе странный ход, 
    и из отладночного вывода непонятно почему бот сходил именно так, 
    вы можете скопировать из логов входные данные в юнит-тест,
    и запустить тест под отладчиком, изучив причины.
    

4. Хорошая практика тестирования симуляции — написать код, проверяющий корректность симуляции, 
и запускать его первое время после каждого хода. Обратите внимание на метод `State.EnsureValid`.
Сейчас его вызов отключен директивой компиляции, но проверки в любой момент можно включить обратно.
В будущем, когда вы будете программировать симуляцию сами, 
эта практика без преувеличения может сэкономить вам часы на отладке.